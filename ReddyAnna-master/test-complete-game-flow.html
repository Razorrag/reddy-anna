<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Game Flow Test - Reddy Anna Kossu</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-info {
            background-color: #e7f3fe;
            color: #0c5460;
        }
        .log-success {
            background-color: #d4edda;
            color: #155724;
        }
        .log-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .game-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .status-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .status-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 18px;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>Complete Game Flow Test - Reddy Anna Kossu</h1>
    
    <div class="container">
        <h2>Test Configuration</h2>
        <div class="test-section">
            <label for="apiBaseUrl">API Base URL:</label>
            <input type="text" id="apiBaseUrl" value="http://localhost:4001" style="width: 300px; padding: 5px;">
            <button onclick="updateApiUrl()">Update</button>
            <div class="status info">
                <strong>Note:</strong> Make sure the backend server is running on the configured URL.
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Game Status</h2>
        <div class="status-display">
            <div class="status-item">
                <div class="status-label">Backend Connection</div>
                <div class="status-value" id="backendStatus">Not Connected</div>
            </div>
            <div class="status-item">
                <div class="status-label">WebSocket Connection</div>
                <div class="status-value" id="wsStatus">Not Connected</div>
            </div>
            <div class="status-item">
                <div class="status-label">Current Game Phase</div>
                <div class="status-value" id="gamePhase">Unknown</div>
            </div>
            <div class="status-item">
                <div class="status-label">Timer</div>
                <div class="status-value" id="timerValue">--</div>
            </div>
            <div class="status-item">
                <div class="status-label">Opening Card</div>
                <div class="status-value" id="openingCard">None</div>
            </div>
            <div class="status-item">
                <div class="status-label">Cards Dealt</div>
                <div class="status-value" id="cardsDealt">0</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>Test Controls</h2>
        <div class="game-controls">
            <button onclick="testBackendConnection()">Test Backend Connection</button>
            <button onclick="testWebSocketConnection()">Test WebSocket Connection</button>
            <button onclick="testGameFlow()">Run Complete Game Flow Test</button>
            <button onclick="simulateAdminFlow()">Simulate Admin Flow</button>
            <button onclick="simulateUserFlow()">Simulate User Flow</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <div class="container">
        <h2>Test Results</h2>
        <div id="testResults"></div>
    </div>

    <div class="container">
        <h2>Test Logs</h2>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        // Configuration
        let API_BASE_URL = 'http://localhost:4001';
        let websocketConnection = null;
        let testResults = {};

        // Update API URL
        function updateApiUrl() {
            API_BASE_URL = document.getElementById('apiBaseUrl').value;
            log(`API Base URL updated to: ${API_BASE_URL}`, 'info');
        }

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Update status display
        function updateStatus(elementId, value, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.className = `status-value ${type}`;
            }
        }

        // Add test result
        function addTestResult(testName, passed, message) {
            testResults[testName] = { passed, message };
            const resultsContainer = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'success' : 'error'}`;
            resultDiv.innerHTML = `<strong>${testName}:</strong> ${passed ? 'PASSED' : 'FAILED'} - ${message}`;
            resultsContainer.appendChild(resultDiv);
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('testResults').innerHTML = '';
            testResults = {};
        }

        // Test backend connection
        async function testBackendConnection() {
            log('Testing backend connection...', 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    log(`Backend connection successful: ${JSON.stringify(data)}`, 'success');
                    updateStatus('backendStatus', 'Connected', 'success');
                    addTestResult('Backend Connection', true, 'Backend is responding');
                    return true;
                } else {
                    log(`Backend connection failed: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('backendStatus', 'Error', 'error');
                    addTestResult('Backend Connection', false, `HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`Backend connection error: ${error.message}`, 'error');
                updateStatus('backendStatus', 'Error', 'error');
                addTestResult('Backend Connection', false, error.message);
                return false;
            }
        }

        // Test WebSocket connection
        function testWebSocketConnection() {
            return new Promise((resolve) => {
                log('Testing WebSocket connection...', 'info');
                
                try {
                    const wsUrl = API_BASE_URL.replace('http', 'ws');
                    websocketConnection = new WebSocket(wsUrl);
                    
                    websocketConnection.onopen = function() {
                        log('WebSocket connection established', 'success');
                        updateStatus('wsStatus', 'Connected', 'success');
                        addTestResult('WebSocket Connection', true, 'WebSocket is connected');
                        resolve(true);
                    };
                    
                    websocketConnection.onerror = function(error) {
                        log(`WebSocket connection error: ${error}`, 'error');
                        updateStatus('wsStatus', 'Error', 'error');
                        addTestResult('WebSocket Connection', false, 'Connection error');
                        resolve(false);
                    };
                    
                    websocketConnection.onclose = function(event) {
                        log(`WebSocket connection closed: ${event.code} ${event.reason}`, 'info');
                        updateStatus('wsStatus', 'Disconnected', 'warning');
                    };
                    
                    // Set a timeout for connection
                    setTimeout(() => {
                        if (websocketConnection.readyState === WebSocket.CONNECTING) {
                            log('WebSocket connection timeout', 'error');
                            updateStatus('wsStatus', 'Timeout', 'error');
                            addTestResult('WebSocket Connection', false, 'Connection timeout');
                            websocketConnection.close();
                            resolve(false);
                        }
                    }, 5000);
                    
                } catch (error) {
                    log(`WebSocket initialization error: ${error.message}`, 'error');
                    updateStatus('wsStatus', 'Error', 'error');
                    addTestResult('WebSocket Connection', false, error.message);
                    resolve(false);
                }
            });
        }

        // Test game settings
        async function testGameSettings() {
            log('Testing game settings...', 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/api/game/settings`);
                if (response.ok) {
                    const data = await response.json();
                    log(`Game settings retrieved: ${JSON.stringify(data)}`, 'success');
                    addTestResult('Game Settings', true, 'Settings API working');
                    return data;
                } else {
                    log(`Failed to get game settings: ${response.status}`, 'error');
                    addTestResult('Game Settings', false, `HTTP ${response.status}`);
                    return null;
                }
            } catch (error) {
                log(`Error testing game settings: ${error.message}`, 'error');
                addTestResult('Game Settings', false, error.message);
                return null;
            }
        }

        // Test opening card setting
        async function testSetOpeningCard() {
            log('Testing opening card setting...', 'info');
            try {
                const testCard = 'A♠';
                const response = await fetch(`${API_BASE_URL}/api/game/set-opening-card`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        card: testCard,
                        game_id: 'test-game'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Opening card set successfully: ${JSON.stringify(data)}`, 'success');
                    updateStatus('openingCard', testCard, 'success');
                    addTestResult('Set Opening Card', true, `Card set to ${testCard}`);
                    return true;
                } else {
                    log(`Failed to set opening card: ${response.status}`, 'error');
                    addTestResult('Set Opening Card', false, `HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`Error setting opening card: ${error.message}`, 'error');
                addTestResult('Set Opening Card', false, error.message);
                return false;
            }
        }

        // Test timer start
        async function testStartTimer() {
            log('Testing timer start...', 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/api/game/start-timer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        duration: 30,
                        phase: 'betting',
                        game_id: 'test-game'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Timer started successfully: ${JSON.stringify(data)}`, 'success');
                    updateStatus('gamePhase', 'betting', 'success');
                    addTestResult('Start Timer', true, 'Timer started for 30 seconds');
                    return true;
                } else {
                    log(`Failed to start timer: ${response.status}`, 'error');
                    addTestResult('Start Timer', false, `HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`Error starting timer: ${error.message}`, 'error');
                addTestResult('Start Timer', false, error.message);
                return false;
            }
        }

        // Test bet placement
        async function testPlaceBet() {
            log('Testing bet placement...', 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/api/game/place-bet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 'test-user',
                        gameId: 'test-game',
                        round: 'round1',
                        side: 'andar',
                        amount: 1000
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Bet placed successfully: ${JSON.stringify(data)}`, 'success');
                    addTestResult('Place Bet', true, 'Bet of ₹1000 placed on Andar');
                    return true;
                } else {
                    log(`Failed to place bet: ${response.status}`, 'error');
                    addTestResult('Place Bet', false, `HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`Error placing bet: ${error.message}`, 'error');
                addTestResult('Place Bet', false, error.message);
                return false;
            }
        }

        // Test card dealing
        async function testDealCard() {
            log('Testing card dealing...', 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/api/game/deal-card`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        card: 'K♥',
                        side: 'bahar',
                        position: 1,
                        game_id: 'test-game'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Card dealt successfully: ${JSON.stringify(data)}`, 'success');
                    updateStatus('cardsDealt', '1', 'success');
                    addTestResult('Deal Card', true, 'Card K♥ dealt to Bahar');
                    return true;
                } else {
                    log(`Failed to deal card: ${response.status}`, 'error');
                    addTestResult('Deal Card', false, `HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`Error dealing card: ${error.message}`, 'error');
                addTestResult('Deal Card', false, error.message);
                return false;
            }
        }

        // Test winning card
        async function testWinningCard() {
            log('Testing winning card detection...', 'info');
            try {
                // First set opening card to A♠
                await fetch(`${API_BASE_URL}/api/game/set-opening-card`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        card: 'A♠',
                        game_id: 'test-game'
                    })
                });
                
                // Now deal a matching card
                const response = await fetch(`${API_BASE_URL}/api/game/deal-card`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        card: 'A♥',
                        side: 'andar',
                        position: 2,
                        game_id: 'test-game'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.data.isWinningCard) {
                        log(`Winning card detected correctly: ${JSON.stringify(data)}`, 'success');
                        addTestResult('Winning Card Detection', true, 'A♥ detected as winning card');
                        return true;
                    } else {
                        log(`Winning card not detected: ${JSON.stringify(data)}`, 'error');
                        addTestResult('Winning Card Detection', false, 'Winning card not detected');
                        return false;
                    }
                } else {
                    log(`Failed to deal winning card: ${response.status}`, 'error');
                    addTestResult('Winning Card Detection', false, `HTTP ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`Error testing winning card: ${error.message}`, 'error');
                addTestResult('Winning Card Detection', false, error.message);
                return false;
            }
        }

        // Run complete game flow test
        async function testGameFlow() {
            log('Starting complete game flow test...', 'info');
            clearLogs();
            
            const tests = [
                { name: 'Backend Connection', func: testBackendConnection },
                { name: 'WebSocket Connection', func: testWebSocketConnection },
                { name: 'Game Settings', func: testGameSettings },
                { name: 'Set Opening Card', func: testSetOpeningCard },
                { name: 'Start Timer', func: testStartTimer },
                { name: 'Place Bet', func: testPlaceBet },
                { name: 'Deal Card', func: testDealCard },
                { name: 'Winning Card Detection', func: testWinningCard }
            ];
            
            let passedTests = 0;
            for (const test of tests) {
                const result = await test.func();
                if (result) passedTests++;
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
            }
            
            log(`Game flow test completed: ${passedTests}/${tests.length} tests passed`, 
                passedTests === tests.length ? 'success' : 'warning');
            
            // Show summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `status ${passedTests === tests.length ? 'success' : 'warning'}`;
            summaryDiv.innerHTML = `<strong>Test Summary:</strong> ${passedTests}/${tests.length} tests passed`;
            document.getElementById('testResults').appendChild(summaryDiv);
        }

        // Simulate admin flow
        async function simulateAdminFlow() {
            log('Simulating admin flow...', 'info');
            window.open('game-admin.html', '_blank');
        }

        // Simulate user flow
        async function simulateUserFlow() {
            log('Simulating user flow...', 'info');
            window.open('start-game.html', '_blank');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('Game flow test tool loaded', 'info');
            updateApiUrl();
        });
    </script>
</body>
</html>