# ====================================================================
# WORKING NGINX CONFIG - Based on Your Original + HLS Cache Optimization
# ====================================================================
# This config:
# 1. Keeps your original working proxy setup (backend serves everything)
# 2. Adds HLS cache optimization for streaming
# 3. Maintains all your working routes (/api/, /ws, /live/)
# ====================================================================

server {
    listen 80;
    listen [::]:80;
    server_name rajugarikossu.com www.rajugarikossu.com;

    # Redirect HTTP to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen [::]:443 ssl ipv6only=on http2;
    listen 443 ssl http2;
    server_name rajugarikossu.com www.rajugarikossu.com;

    # SSL Configuration (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/rajugarikossu.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/rajugarikossu.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Content Security Policy - Allow hls.js CDN
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; media-src 'self' https: blob:; connect-src 'self' https: wss: ws:;" always;

    # Allow large uploads
    client_max_body_size 50M;

    # Logging
    access_log /var/log/nginx/reddy-anna-access.log;
    error_log  /var/log/nginx/reddy-anna-error.log;

    # ==========================================
    # HLS STREAMING WITH RAM CACHE (OPTIMIZED)
    # ==========================================
    location /live/ {
        proxy_pass http://127.0.0.1:8000/live/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ==========================================
        # ✅ NEW: CACHING CONFIGURATION
        # ==========================================
        proxy_cache stream_cache;
        proxy_cache_valid 200 10s;              # Cache successful responses for 10s
        proxy_cache_use_stale updating error timeout;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        proxy_cache_min_uses 1;
        
        # Bypass cache for playlists (always fresh)
        set $is_playlist 0;
        if ($uri ~* \.m3u8$) {
            set $is_playlist 1;
        }
        proxy_cache_bypass $is_playlist;
        proxy_no_cache $is_playlist;
        
        # Cache status header (for debugging)
        add_header X-Cache-Status $upstream_cache_status always;
        # ==========================================

        # CORS for HLS segments
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Range, Accept-Encoding, Referer, Cache-Control" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;

        # Handle OPTIONS preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            add_header Access-Control-Allow-Headers "Range";
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Content-Length 0;
            return 204;
        }

        # Force correct MIME types for HLS files
        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
        }

        # ✅ OPTIMIZED: Enable buffering for caching
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # TCP optimizations
        tcp_nodelay on;
        tcp_nopush on;
    }

    # ==========================================
    # HLS PLAYER PAGE
    # ==========================================
    location /player {
        alias /var/www/andar-bahar/reddy-anna/live_stream/player.html;
    }

    # ==========================================
    # WEBSOCKET ENDPOINT (MUST BE BEFORE /)
    # ==========================================
    location /ws {
        proxy_pass http://127.0.0.1:5000/ws;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # ==========================================
    # STATIC ASSETS CACHING (BEFORE /)
    # ==========================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:5000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==========================================
    # MAIN APPLICATION PROXY (CATCH-ALL - LAST)
    # ==========================================
    # ✅ This proxies EVERYTHING (React app + API) to your backend
    # Your backend serves the React app AND handles API routes
    location / {
        proxy_pass http://127.0.0.1:5000;

        # WebSocket & keepalive
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# ====================================================================
# WHAT'S DIFFERENT FROM YOUR OLD CONFIG:
# ====================================================================
# 1. ✅ Added HLS cache configuration (lines 58-71)
# 2. ✅ Optimized proxy buffering for streaming (lines 97-105)
# 3. ✅ Added X-Cache-Status header for debugging
# 4. ✅ Kept your original proxy_pass setup (everything goes to port 5000)
# 5. ✅ HTTP to HTTPS redirect moved to separate server block
#
# Everything else is IDENTICAL to your working config!
# ====================================================================

# ====================================================================
# DEPLOYMENT INSTRUCTIONS:
# ====================================================================
# 1. Backup current config:
#    sudo cp /etc/nginx/sites-available/andar-bahar /etc/nginx/sites-available/andar-bahar.backup-$(date +%Y%m%d-%H%M%S)
#
# 2. Copy this entire file content to:
#    sudo nano /etc/nginx/sites-available/andar-bahar
#    (Delete everything, paste this entire content, save with Ctrl+O, Enter, Ctrl+X)
#
# 3. Test configuration:
#    sudo nginx -t
#
# 4. If test passes, reload nginx:
#    sudo systemctl reload nginx
#
# 5. Create cache directory (if not already exists):
#    sudo mkdir -p /dev/shm/stream_cache
#    sudo chown -R www-data:www-data /dev/shm/stream_cache
#    sudo chmod -R 755 /dev/shm/stream_cache
#
# 6. Verify everything works:
#    # Test login (should work now):
#    curl -X POST https://rajugarikossu.com/api/auth/admin-login \
#      -H "Content-Type: application/json" \
#      -d '{"username":"admin","password":"test"}'
#    # Should return JSON, NOT HTML
#
#    # Test cache (after streaming starts):
#    curl -I https://rajugarikossu.com/live/test/segment0.ts | grep Cache
#    # Should show X-Cache-Status: HIT after first request
#
# 7. Monitor logs:
#    sudo tail -f /var/log/nginx/reddy-anna-error.log
# ====================================================================
