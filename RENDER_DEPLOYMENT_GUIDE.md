# üöÄ Render Deployment Guide

Complete guide to deploy your Andar Bahar game application on Render.

## üìã Prerequisites

1. **Render Account**: Sign up at [render.com](https://render.com) (free tier available)
2. **GitHub/GitLab/Bitbucket Repository**: Your code should be in a Git repository
3. **Supabase Account**: For database and authentication (free tier available)
4. **Supabase Credentials**: You'll need:
   - `SUPABASE_URL`
   - `SUPABASE_SERVICE_KEY` (service_role key)
   - `SUPABASE_ANON_KEY` (anon/public key)

---

## üéØ Step-by-Step Deployment

### Step 1: Prepare Your Repository

1. **Commit your `render.yaml` file** to your repository:
   ```bash
   git add render.yaml
   git commit -m "Add Render deployment configuration"
   git push
   ```

2. **Verify your build process** works locally:
   ```bash
   npm install
   npm run build
   ```

### Step 2: Create a New Web Service on Render

1. Go to your [Render Dashboard](https://dashboard.render.com)
2. Click **"New +"** ‚Üí **"Blueprint"** (if using render.yaml) OR **"Web Service"**
3. Connect your repository:
   - Authorize Render to access your GitHub/GitLab/Bitbucket account
   - Select the repository containing your code

### Step 3: Configure the Service (if not using render.yaml)

If you're **not using render.yaml**, configure manually:

- **Name**: `andar-bahar-game` (or your preferred name)
- **Environment**: `Node`
- **Region**: Choose closest to your users (e.g., `Oregon`, `Frankfurt`, `Singapore`)
- **Branch**: `main` (or your default branch)
- **Root Directory**: Leave empty (root of repo)
- **Build Command**: `npm install && npm run build`
- **Start Command**: `npm start`

### Step 4: Set Environment Variables

Add the following environment variables in Render dashboard:

#### ‚úÖ **Required Variables**:

```
NODE_ENV=production
JWT_SECRET=<auto-generated or set your own secure random string>
JWT_EXPIRES_IN=7d
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_KEY=your_service_role_key_here
SUPABASE_ANON_KEY=your_anon_key_here
```

#### üîß **Optional Variables** (with defaults):

```
CORS_ORIGIN=https://your-app-name.onrender.com
ALLOWED_ORIGINS=https://your-app-name.onrender.com,https://your-custom-domain.com
DEFAULT_BALANCE=1000
```

**Note**: 
- `PORT` is automatically provided by Render - **DO NOT SET IT MANUALLY**
- `JWT_SECRET` can be auto-generated by Render (set in render.yaml) or generate one yourself:
  ```bash
  node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
  ```

### Step 5: Deploy

1. Click **"Create Web Service"** (or **"Save Changes"** if editing)
2. Render will:
   - Clone your repository
   - Install dependencies (`npm install`)
   - Build your application (`npm run build`)
   - Start your server (`npm start`)

3. **Monitor the build logs** for any errors

### Step 6: Verify Deployment

Once deployed, your app will be available at:
```
https://your-app-name.onrender.com
```

Test the following:

1. **Visit the root URL**: Should load your frontend
2. **Test API endpoint**: 
   ```bash
   curl https://your-app-name.onrender.com/api/game/current
   ```
3. **Check WebSocket**: The app uses WebSockets at `/ws` - ensure it's working

---

## üîß Configuration Details

### Build Process

The build process (`npm run build`) does the following:

1. **Installs client dependencies**: `cd client && npm install`
2. **Builds React frontend**: `cd client && npm run build`
3. **Copies client build**: Client files ‚Üí `dist/public/`
4. **Builds server**: Server TypeScript ‚Üí `dist/index.js`

The final structure:
```
dist/
  ‚îú‚îÄ‚îÄ index.js          # Compiled server
  ‚îî‚îÄ‚îÄ public/           # Built React app
      ‚îú‚îÄ‚îÄ index.html
      ‚îú‚îÄ‚îÄ assets/
      ‚îî‚îÄ‚îÄ ...
```

### Production Server

In production (`NODE_ENV=production`), the server:
- Serves static files from `dist/public/`
- Handles API routes (`/api/*`)
- Handles WebSocket connections (`/ws`)
- Serves the React app for all other routes (SPA)

### WebSocket Support

Render supports WebSockets automatically. Your app's WebSocket server runs on:
```
wss://your-app-name.onrender.com/ws
```

---

## üåê Custom Domain Setup (Optional)

1. **Add Custom Domain** in Render Dashboard:
   - Go to your service ‚Üí **Settings** ‚Üí **Custom Domains**
   - Add your domain (e.g., `example.com`)
   - Update DNS records as instructed by Render

2. **Update CORS_ORIGIN**:
   ```
   CORS_ORIGIN=https://example.com
   ALLOWED_ORIGINS=https://example.com,https://www.example.com
   ```

3. **Redeploy** to apply changes

---

## üîí Security Considerations

1. **Never commit secrets**:
   - Add `.env` to `.gitignore`
   - Use Render's environment variables

2. **Supabase Keys**:
   - `SUPABASE_SERVICE_KEY`: Keep secret (has admin access)
   - `SUPABASE_ANON_KEY`: Safe for client-side (already public)

3. **JWT Secret**:
   - Must be a long, random string
   - Never share or commit

---

## üìä Monitoring & Logs

### View Logs

1. Go to your service in Render Dashboard
2. Click **"Logs"** tab
3. View real-time logs or download log history

### Health Checks

Render automatically checks:
- **Health Check Path**: `/` (root)
- **Interval**: Every 5 minutes
- **Timeout**: 10 seconds

If health checks fail, Render will:
- Restart the service
- Send notifications (if configured)

---

## üêõ Troubleshooting

### Build Fails

**Error**: `Missing postcss.config.js`
- **Fix**: Ensure `client/postcss.config.js` exists and is committed

**Error**: `Production build not found`
- **Fix**: Check that `npm run build` completes successfully
- Verify `dist/public/` directory exists after build

**Error**: `Module not found`
- **Fix**: Ensure all dependencies are in `package.json`
- Run `npm install` locally to verify

### Runtime Errors

**Error**: `Missing required environment variables`
- **Fix**: Add all required environment variables in Render dashboard

**Error**: `Cannot connect to Supabase`
- **Fix**: Verify `SUPABASE_URL` and `SUPABASE_SERVICE_KEY` are correct
- Check Supabase project is active

**Error**: `Port already in use`
- **Fix**: Don't set `PORT` manually - Render provides it automatically

### WebSocket Issues

**Issue**: WebSocket connection fails
- **Fix**: Ensure you're using `wss://` (secure WebSocket) in production
- Check that WebSocket path is `/ws`
- Verify Render WebSocket support is enabled (it is by default)

### CORS Errors

**Issue**: CORS errors in browser console
- **Fix**: Update `CORS_ORIGIN` and `ALLOWED_ORIGINS` to match your Render URL
- Ensure domain matches exactly (including `https://`)

---

## üí∞ Pricing & Plans

### Free Tier
- **Limitations**:
  - Service spins down after 15 minutes of inactivity
  - Limited CPU/RAM
  - Slower cold starts

### Starter Plan ($7/month)
- Always on
- Better performance
- No cold starts
- Recommended for production

### Standard Plan ($25/month)
- Even better performance
- Auto-scaling
- Custom domains included

---

## üìù Post-Deployment Checklist

- [ ] App loads at Render URL
- [ ] API endpoints work (`/api/game/current`)
- [ ] WebSocket connections work (`/ws`)
- [ ] Authentication works (signup/login)
- [ ] Database connections work (Supabase)
- [ ] Environment variables are set correctly
- [ ] Custom domain configured (if applicable)
- [ ] CORS configured for your domain
- [ ] Health checks passing
- [ ] Logs show no errors

---

## üîÑ Updating Your Deployment

1. **Push changes to your repository**:
   ```bash
   git add .
   git commit -m "Your changes"
   git push
   ```

2. **Render automatically deploys**:
   - Watches your repository
   - Triggers new build on push
   - Deploys to production after successful build

3. **Manual deploy** (if auto-deploy is off):
   - Go to Render Dashboard
   - Click **"Manual Deploy"** ‚Üí **"Deploy latest commit"**

---

## üìö Additional Resources

- [Render Documentation](https://render.com/docs)
- [Render WebSocket Support](https://render.com/docs/websockets)
- [Render Environment Variables](https://render.com/docs/environment-variables)
- [Supabase Documentation](https://supabase.com/docs)

---

## üÜò Support

If you encounter issues:

1. **Check Render logs** for error messages
2. **Verify environment variables** are set correctly
3. **Test locally** with `NODE_ENV=production npm start`
4. **Check Render Status**: [status.render.com](https://status.render.com)
5. **Render Support**: Available in dashboard or [community.render.com](https://community.render.com)

---

## ‚úÖ Success!

Once deployed, your Andar Bahar game will be live at:
```
https://your-app-name.onrender.com
```

Happy gaming! üéÆ

