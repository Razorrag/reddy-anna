# ====================================================================
# NGINX API PROXY FIX - LOGIN ISSUE RESOLVED
# ====================================================================
# PROBLEM: The trailing slash in proxy_pass was stripping /api prefix
# SOLUTION: Remove trailing slash to preserve the full URI path
# ====================================================================

# ❌ INCORRECT CONFIG (was causing login failure):
# location /api/ {
#     proxy_pass http://127.0.0.1:5000/;  # Trailing slash strips /api
# }
# This forwards /api/auth/login as /auth/login (missing /api)

# ✅ CORRECT CONFIG (fixes login):
location /api/ {
    proxy_pass http://127.0.0.1:5000;  # NO trailing slash = preserves /api
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Timeouts for API
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# ====================================================================
# HOW THIS WORKS:
# ====================================================================
# Frontend request: https://rajugarikossu.com/api/auth/login
# 
# With trailing slash (WRONG):
#   nginx strips /api and forwards: http://127.0.0.1:5000/auth/login ❌
#   Backend route expects: /api/auth/login
#   Result: 404 Not Found
#
# Without trailing slash (CORRECT):
#   nginx preserves full path: http://127.0.0.1:5000/api/auth/login ✅
#   Backend route matches: /api/auth/login
#   Result: Login works!
# ====================================================================

# ====================================================================
# DEPLOYMENT STEPS:
# ====================================================================
# 1. Open your nginx config:
#    sudo nano /etc/nginx/sites-available/andar-bahar
#
# 2. Find the location /api/ block (around line 134)
#
# 3. Change line 135 from:
#    proxy_pass http://127.0.0.1:5000/;
#    to:
#    proxy_pass http://127.0.0.1:5000;
#    (Remove the trailing slash after 5000)
#
# 4. Save the file (Ctrl+X, Y, Enter)
#
# 5. Test the configuration:
#    sudo nginx -t
#
# 6. If test passes, reload nginx:
#    sudo systemctl reload nginx
#
# 7. Test login immediately - it should work now!
# ====================================================================

# ====================================================================
# VERIFICATION:
# ====================================================================
# After applying the fix, test with curl:
#
# curl -X POST https://rajugarikossu.com/api/auth/login \
#   -H "Content-Type: application/json" \
#   -d '{"phone":"YOUR_PHONE","password":"YOUR_PASSWORD"}' \
#   -v
#
# You should see:
# - HTTP/1.1 200 OK (or 401 if credentials wrong, which is expected)
# - NOT HTTP/1.1 404 Not Found
#
# Then test in browser - login should work!
# ====================================================================